 #include "stm32f10x.h"

void clock_config(void);
void gpio_init(void);
void tim2_init(void);

int main(void) {
    clock_config();   // ????????? ???????????? ?? 72 ???
    gpio_init();      // ????????? ???? PB2 (?????????)
    tim2_init();      // ????????? ?????? TIM2 ?? ??????????

    while (1) {
        // ????? ?????? ?? ??????, ??? ?????? ??????????
    }
}

// ———————————————————————————
// ????????? GPIO
void gpio_init(void) {
    RCC->APB2ENR |= RCC_APB2ENR_IOPBEN;         // ???????? ???????????? ????? B
    GPIOB->CRL &= ~(GPIO_CRL_MODE2 | GPIO_CRL_CNF2); // ????? ???????? PB2
    GPIOB->CRL |= GPIO_CRL_MODE2_1;             // PB2 — ?????, 2 ???, push-pull
}

// ———————————————————————————
// ????????? ??????? TIM2
void tim2_init(void) {
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;         // ???????? ???????????? TIM2

    TIM2->PSC = 7200 - 1;   // ????????????: 72 ??? / 7200 = 10 000 ??
    TIM2->ARR = 5000 - 1;   // ????????????????: 10 000 / 5000 = ?????? 0.5 ???

    TIM2->DIER |= TIM_DIER_UIE;  // ????????? ?????????? ?? ????????????
    TIM2->CR1 |= TIM_CR1_CEN;    // ????????? ??????

    NVIC_EnableIRQ(TIM2_IRQn);   // ???????? ?????????? TIM2 ? ??????????? NVIC
}

// ———————————————————————————
// ?????????? ?????????? ??????? TIM2
void TIM2_IRQHandler(void) {
    if (TIM2->SR & TIM_SR_UIF) {         // ????????, ??? ??? ????????????
        TIM2->SR &= ~TIM_SR_UIF;         // ????? ????? ????????????
        GPIOB->ODR ^= (1 << 2);          // ??????????? PB2 (?????? ???????????)
    }
}

// ———————————————————————————
// ????????? ??????? 72 ??? (?? ??? ?????? ??? ?????)
void clock_config(void) {
    RCC->CR |= RCC_CR_HSION;
    RCC->CFGR = 0;
    RCC->CR &= ~(RCC_CR_HSEON | RCC_CR_PLLON);
    RCC->CIR = 0;

    RCC->CR |= RCC_CR_HSEON;
    uint32_t timeout = 1000000;
    while (!(RCC->CR & RCC_CR_HSERDY) && --timeout);
    if (!(RCC->CR & RCC_CR_HSERDY)) return;

    FLASH->ACR |= FLASH_ACR_PRFTBE;
    FLASH->ACR &= ~FLASH_ACR_LATENCY;
    FLASH->ACR |= FLASH_ACR_LATENCY_2;

    RCC->CFGR |= RCC_CFGR_HPRE_DIV1;
    RCC->CFGR |= RCC_CFGR_PPRE1_DIV2;
    RCC->CFGR |= RCC_CFGR_PPRE2_DIV1;
    RCC->CFGR |= RCC_CFGR_ADCPRE_DIV6;

    RCC->CFGR |= RCC_CFGR_PLLSRC;
    RCC->CFGR |= RCC_CFGR_PLLMULL9;

    RCC->CR |= RCC_CR_PLLON;
    while (!(RCC->CR & RCC_CR_PLLRDY));

    RCC->CFGR &= ~RCC_CFGR_SW;
    RCC->CFGR |= RCC_CFGR_SW_PLL;
    while ((RCC->CFGR & RCC_CFGR_SWS) != RCC_CFGR_SWS_PLL);
}
